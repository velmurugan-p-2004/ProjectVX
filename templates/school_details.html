<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Details - VishnoRex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/salary_management.css') }}">
</head>
<body>
    <!-- Mobile Sidebar Toggle -->
    <button type="button" class="sidebar-toggle d-md-none" id="sidebarToggle" title="Toggle sidebar menu">
        <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
        <div class="row">
            <!-- Enhanced Sidebar -->
            <nav class="col-md-2 d-none d-md-block enhanced-sidebar">
                <div class="sidebar-header">
                    <div class="brand-logo">
                        <div class="logo-icon">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="brand-text">
                            <h6 class="brand-title">{{ school.name }}</h6>
                            <small class="brand-subtitle">School Details</small>
                        </div>
                    </div>
                </div>
                <div class="sidebar-content">
                    <!-- User Profile Section -->
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ session.get('full_name', 'Company Admin') }}</div>
                            <div class="user-role">Company Administrator</div>
                        </div>
                    </div>
                    <!-- Navigation Menu -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>School Overview</span>
                        </div>
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a class="nav-link active" href="#school-info" onclick="scrollToSection('school-info')">
                                    <div class="nav-icon">
                                        <i class="bi bi-info-circle"></i>
                                    </div>
                                    <span class="nav-text">School Information</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#admins-section" onclick="scrollToSection('admins-section')">
                                    <div class="nav-icon">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <span class="nav-text">Administrators</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#staff-section" onclick="scrollToSection('staff-section')">
                                    <div class="nav-icon">
                                        <i class="bi bi-people"></i>
                                    </div>
                                    <span class="nav-text">Staff Members</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#attendance-section" onclick="scrollToSection('attendance-section')">
                                    <div class="nav-icon">
                                        <i class="bi bi-calendar-check"></i>
                                    </div>
                                    <span class="nav-text">Today's Attendance</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Quick Actions Section -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-lightning"></i>
                            <span>Quick Actions</span>
                        </div>
                        <div class="quick-actions">
                            <button type="button" class="quick-action-btn" data-bs-toggle="modal" data-bs-target="#addAdminModal" title="Add Admin">
                                <i class="bi bi-person-plus"></i>
                                <span>Add Admin</span>
                            </button>
                            <button type="button" class="quick-action-btn" onclick="exportSchoolData()" title="Export Data">
                                <i class="bi bi-download"></i>
                                <span>Export</span>
                            </button>
                            <button type="button" class="quick-action-btn" onclick="refreshData()" title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar Footer -->
                <div class="sidebar-footer">
                    <div class="footer-stats">
                        <div class="stat-item">
                            <i class="bi bi-person-badge"></i>
                            <span id="totalAdminsCount">{{ admins|length if admins else 0 }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="bi bi-people"></i>
                            <span id="totalStaffCount">{{ staff|length if staff else 0 }}</span>
                        </div>
                    </div>
                    <a href="{{ url_for('company_dashboard') }}" class="logout-btn" title="Back to Schools">
                        <i class="bi bi-arrow-left"></i>
                        <span>Back to Schools</span>
                    </a>
                </div>
            </nav>
            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto px-md-4 salary-main-content">
                <!-- Enhanced Header -->
                <div class="salary-header">
                    <div class="header-content">
                        <div class="header-title">
                            <div class="title-icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <div class="title-text">
                                <h1 class="main-title">{{ school.name }}</h1>
                                <p class="subtitle">School Details and Management Dashboard</p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshData()" title="Refresh data">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportSchoolData()" title="Export school data">
                                <i class="bi bi-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- School Information Card -->
                <div class="salary-filters-card" id="school-info">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">School Information</h5>
                            <p class="card-subtitle">Basic details and contact information</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <div class="info-label">
                                        <i class="bi bi-building me-2 text-primary"></i>
                                        <strong>School Name:</strong>
                                    </div>
                                    <div class="info-value">{{ school.name }}</div>
                                </div>
                                <div class="info-item mb-3">
                                    <div class="info-label">
                                        <i class="bi bi-geo-alt me-2 text-primary"></i>
                                        <strong>Address:</strong>
                                    </div>
                                    <div class="info-value">{{ school.address or 'Not specified' }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item mb-3">
                                    <div class="info-label">
                                        <i class="bi bi-envelope me-2 text-primary"></i>
                                        <strong>Contact Email:</strong>
                                    </div>
                                    <div class="info-value">{{ school.contact_email or 'Not provided' }}</div>
                                </div>
                                <div class="info-item mb-3">
                                    <div class="info-label">
                                        <i class="bi bi-telephone me-2 text-primary"></i>
                                        <strong>Contact Phone:</strong>
                                    </div>
                                    <div class="info-value">{{ school.contact_phone or 'Not provided' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Administrators Section -->
                <div class="salary-filters-card" id="admins-section">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Administrators</h5>
                            <p class="card-subtitle">Manage school administrators and access rights</p>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                                <i class="bi bi-plus-lg"></i> Add Admin
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table salary-table">
                                <thead>
                                    <tr>
                                        <th><i class="bi bi-person me-2"></i>Username</th>
                                        <th><i class="bi bi-person-circle me-2"></i>Full Name</th>
                                        <th><i class="bi bi-envelope me-2"></i>Email</th>
                                        <th><i class="bi bi-gear me-2"></i>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admin in admins %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-2">
                                                    <i class="bi bi-person-badge"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ admin.username }}</div>
                                                    <small class="text-muted">Administrator</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ admin.full_name }}</td>
                                        <td>
                                            {% if admin.email %}
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-envelope text-primary me-1"></i>
                                                    {{ admin.email }}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">Not provided</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger delete-admin" data-admin-id="{{ admin.id }}" title="Delete Admin">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-4">
                                            <div class="empty-state">
                                                <i class="bi bi-person-badge text-muted" style="font-size: 3rem;"></i>
                                                <h5 class="text-muted mt-3">No Administrators Found</h5>
                                                <p class="text-muted">Add the first administrator for this school.</p>
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                                                    <i class="bi bi-plus-lg"></i> Add First Admin
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Add Admin Modal -->
                <div class="modal fade" id="addAdminModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Add New Admin</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="adminForm">
                                    <div class="mb-3">
                                        <label for="newAdminUsername" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="newAdminUsername" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newAdminPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="newAdminPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newAdminFullName" class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="newAdminFullName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newAdminEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="newAdminEmail">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveAdmin">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Members Section -->
                <div class="salary-filters-card" id="staff-section">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Staff Members ({{ staff|length }})</h5>
                            <p class="card-subtitle">View all staff members registered in this school</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table salary-table">
                                <thead>
                                    <tr>
                                        <th><i class="bi bi-card-text me-2"></i>Staff ID</th>
                                        <th><i class="bi bi-person me-2"></i>Full Name</th>
                                        <th><i class="bi bi-building me-2"></i>Department</th>
                                        <th><i class="bi bi-briefcase me-2"></i>Position</th>
                                        <th><i class="bi bi-envelope me-2"></i>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member in staff %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ member.staff_id }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-2">
                                                    <i class="bi bi-person-circle"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ member.full_name }}</div>
                                                    <small class="text-muted">Staff Member</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ member.department }}</span>
                                        </td>
                                        <td>{{ member.position }}</td>
                                        <td>
                                            {% if member.email %}
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-envelope text-primary me-1"></i>
                                                    {{ member.email }}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">Not provided</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="empty-state">
                                                <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                                                <h5 class="text-muted mt-3">No Staff Members Found</h5>
                                                <p class="text-muted">Staff members will appear here once they are registered in the system.</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Today's Attendance Section -->
                <div class="salary-filters-card" id="attendance-section">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Today's Attendance</h5>
                            <p class="card-subtitle">{{ today.strftime('%A, %B %d, %Y') if today else 'Current Date' }}</p>
                        </div>
                        <div class="header-actions">
                            <div class="attendance-badges">
                                <span class="badge bg-success me-2">
                                    <i class="bi bi-check-circle me-1"></i>
                                    {{ attendance_summary.present if attendance_summary else 0 }} Present
                                </span>
                                <span class="badge bg-danger me-2">
                                    <i class="bi bi-x-circle me-1"></i>
                                    {{ attendance_summary.absent if attendance_summary else 0 }} Absent
                                </span>
                                <span class="badge bg-warning me-2">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ attendance_summary.late if attendance_summary else 0 }} Late
                                </span>
                                <span class="badge bg-info">
                                    <i class="bi bi-calendar-x me-1"></i>
                                    {{ attendance_summary.on_leave if attendance_summary else 0 }} On Leave
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="attendance-overview">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="stat-card bg-success">
                                        <div class="stat-icon">
                                            <i class="bi bi-check-circle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">{{ attendance_summary.present if attendance_summary else 0 }}</div>
                                            <div class="stat-label">Present</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card bg-danger">
                                        <div class="stat-icon">
                                            <i class="bi bi-x-circle"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">{{ attendance_summary.absent if attendance_summary else 0 }}</div>
                                            <div class="stat-label">Absent</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card bg-warning">
                                        <div class="stat-icon">
                                            <i class="bi bi-clock"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">{{ attendance_summary.late if attendance_summary else 0 }}</div>
                                            <div class="stat-label">Late</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card bg-info">
                                        <div class="stat-icon">
                                            <i class="bi bi-calendar-x"></i>
                                        </div>
                                        <div class="stat-content">
                                            <div class="stat-value">{{ attendance_summary.on_leave if attendance_summary else 0 }}</div>
                                            <div class="stat-label">On Leave</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Enhanced Add Admin Modal -->
    <div class="modal fade" id="addAdminModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Add New Administrator
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminForm">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="section-title">
                                <h6>Administrator Details</h6>
                                <small class="text-muted">Create a new administrator account for this school</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newAdminUsername" class="form-label">
                                <i class="bi bi-person me-1"></i>Username *
                            </label>
                            <input type="text" class="form-control" id="newAdminUsername" required placeholder="Enter username">
                        </div>
                        <div class="mb-3">
                            <label for="newAdminPassword" class="form-label">
                                <i class="bi bi-lock me-1"></i>Password *
                            </label>
                            <input type="password" class="form-control" id="newAdminPassword" required placeholder="Enter password">
                        </div>
                        <div class="mb-3">
                            <label for="newAdminFullName" class="form-label">
                                <i class="bi bi-person-circle me-1"></i>Full Name *
                            </label>
                            <input type="text" class="form-control" id="newAdminFullName" required placeholder="Enter full name">
                        </div>
                        <div class="mb-3">
                            <label for="newAdminEmail" class="form-label">
                                <i class="bi bi-envelope me-1"></i>Email
                            </label>
                            <input type="email" class="form-control" id="newAdminEmail" placeholder="admin@example.com">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveAdmin">
                        <i class="bi bi-check-circle"></i> Create Administrator
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Scroll to section function
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
                
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector(`[href="#${sectionId}"]`).classList.add('active');
            }
        }
        
        // Refresh data function
        function refreshData() {
            location.reload();
        }
        
        // Export school data function
        function exportSchoolData() {
            // TODO: Implement export functionality
            alert('Export functionality coming soon!');
        }

        // Add admin
        document.getElementById('saveAdmin')?.addEventListener('click', function() {
            const username = document.getElementById('newAdminUsername').value;
            const password = document.getElementById('newAdminPassword').value;
            const fullName = document.getElementById('newAdminFullName').value;
            const email = document.getElementById('newAdminEmail').value;

            if (!username || !password || !fullName) {
                alert('Username, Password, and Full Name are required');
                return;
            }

            fetch('/add_admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `school_id={{ school.id }}&username=${username}&password=${encodeURIComponent(password)}&full_name=${encodeURIComponent(fullName)}&email=${email}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Administrator added successfully');
                    location.reload();
                } else {
                    alert(data.error || 'Failed to add administrator');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding administrator');
            });
        });

        // Delete admin
        document.querySelectorAll('.delete-admin').forEach(btn => {
            btn.addEventListener('click', function() {
                const adminId = this.getAttribute('data-admin-id');
                const adminName = this.closest('tr').querySelector('td:nth-child(2)').textContent;

                if (confirm(`Are you sure you want to delete administrator ${adminName}?`)) {
                    fetch('/delete_admin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `admin_id=${adminId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Administrator deleted successfully');
                            location.reload();
                        } else {
                            alert(data.error || 'Failed to delete administrator');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting administrator');
                    });
                }
            });
        });
        
        // Mobile sidebar toggle
        document.getElementById('sidebarToggle')?.addEventListener('click', function() {
            const sidebar = document.querySelector('.enhanced-sidebar');
            sidebar.classList.toggle('show');
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Any initialization code can go here
        });
    </script>
</body>
</html>

    <script>
        // Add admin
        document.getElementById('saveAdmin')?.addEventListener('click', function() {
            const username = document.getElementById('newAdminUsername').value;
            const password = document.getElementById('newAdminPassword').value;
            const fullName = document.getElementById('newAdminFullName').value;
            const email = document.getElementById('newAdminEmail').value;

            if (!username || !password || !fullName) {
                alert('Username, Password, and Full Name are required');
                return;
            }

            fetch('/add_admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `school_id={{ school.id }}&username=${username}&password=${encodeURIComponent(password)}&full_name=${encodeURIComponent(fullName)}&email=${email}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Admin added successfully');
                    location.reload();
                } else {
                    alert(data.error || 'Failed to add admin');
                }
            });
        });

        // Delete admin
        document.querySelectorAll('.delete-admin').forEach(btn => {
            btn.addEventListener('click', function() {
                const adminId = this.getAttribute('data-admin-id');
                const adminName = this.closest('tr').querySelector('td:nth-child(2)').textContent;

                if (confirm(`Are you sure you want to delete admin ${adminName}?`)) {
                    fetch('/delete_admin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `admin_id=${adminId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Admin deleted successfully');
                            location.reload();
                        } else {
                            alert(data.error || 'Failed to delete admin');
                        }
                    });
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

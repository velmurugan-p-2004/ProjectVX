<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Shift Management - VishnoRex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/salary_management.css') }}">
</head>
<body>
    <!-- Mobile Sidebar Toggle -->
    <button type="button" class="sidebar-toggle d-md-none" id="sidebarToggle" title="Toggle sidebar menu">
        <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
        <div class="row">
            <!-- Enhanced Sidebar -->
            <nav class="col-md-2 d-none d-md-block enhanced-sidebar">
                <div class="sidebar-header">
                    <div class="brand-logo">
                        <div class="logo-icon">
                            <i class="bi bi-building-gear"></i>
                        </div>
                        <div class="brand-text">
                            <h6 class="brand-title">VishnoRex</h6>
                            <small class="brand-subtitle">Admin Panel</small>
                        </div>
                    </div>
                </div>

                <div class="sidebar-content">
                    <!-- User Profile Section -->
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ session.get('full_name', 'Admin User') }}</div>
                            <div class="user-role">Administrator</div>
                        </div>
                    </div>

                    <!-- Navigation Menu -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Main Menu</span>
                        </div>
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/dashboard">
                                    <div class="nav-icon">
                                        <i class="bi bi-house-door"></i>
                                    </div>
                                    <span class="nav-text">Dashboard</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('staff_management') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-people"></i>
                                    </div>
                                    <span class="nav-text">Staff Management</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('salary_management') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-currency-dollar"></i>
                                    </div>
                                    <span class="nav-text">Salary Management</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/reports">
                                    <div class="nav-icon">
                                        <i class="bi bi-graph-up"></i>
                                    </div>
                                    <span class="nav-text">Reports & Analytics</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <div class="sidebar-footer">
                    <div class="footer-stats">
                        <div class="stat-item">
                            <i class="bi bi-people"></i>
                            <span id="totalStaffCount">-</span>
                        </div>
                        <div class="stat-item">
                            <i class="bi bi-calendar-day"></i>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <button type="button" class="logout-btn" onclick="logout()" title="Logout">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>
            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto px-md-4 salary-main-content">
                <!-- CSRF Token for AJAX requests -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Enhanced Header -->
                <div class="salary-header">
                    <div class="header-content">
                        <div class="header-title">
                            <div class="title-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="title-text">
                                <h1 class="main-title">Department Shift Management</h1>
                                <p class="subtitle">Configure default shift assignments for departments under Staff Management</p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-outline-primary" id="refreshDataBtn" title="Refresh data">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMappingModal" title="Add new department mapping">
                                <i class="bi bi-plus-circle"></i> Add Department Mapping
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Breadcrumb Navigation -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('staff_management') }}">
                                <i class="bi bi-people"></i> Staff Management
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="bi bi-clock-history"></i> Department Shifts
                        </li>
                    </ol>
                </nav>

                <!-- Information Alert -->
                <div class="salary-results-card mb-4">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">How Department Shifts Work</h5>
                            <p class="card-subtitle">Understanding automatic shift assignment for new staff members</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info border-0 bg-info bg-opacity-10">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-lightbulb text-info fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading text-info">Department Shift Management</h6>
                                    <p class="mb-0">Configure default shift types for each department. When creating new staff members, their shift type will be automatically assigned based on their department. This ensures consistency across your organization and reduces manual work during staff onboarding.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Department Shift Mappings -->
                <div class="salary-results-card" id="departmentShiftsCard">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-building"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Department Shift Mappings</h5>
                            <p class="card-subtitle" id="resultsSubtitle">Manage default shift assignments for all departments</p>
                        </div>
                        <div class="header-actions">
                            <div class="results-stats" id="resultsStats">
                                <div class="stat-item">
                                    <i class="bi bi-building"></i>
                                    <span class="stat-value" id="totalMappingsDisplay">{{ mappings|length }}</span>
                                    <span>Mappings</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="results-container">
                            {% if mappings %}
                            <div class="table-responsive">
                                <table class="table salary-results-table" id="mappingsTable">
                                    <thead>
                                        <tr>
                                            <th>Department</th>
                                            <th>Default Shift Type</th>
                                            <th>Created Date</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mappingsTableBody">
                                        {% for mapping in mappings %}
                                        <tr data-department="{{ mapping.department }}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="department-icon me-2">
                                                        <i class="bi bi-building-fill text-primary"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">{{ mapping.department }}</div>
                                                        <small class="text-muted">Department</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ mapping.default_shift_type.title() }}</span>
                                            </td>
                                            <td>{{ mapping.created_at[:10] if mapping.created_at else 'N/A' }}</td>
                                            <td>{{ mapping.updated_at[:10] if mapping.updated_at else 'N/A' }}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-view-details edit-mapping-btn" 
                                                            data-department="{{ mapping.department }}"
                                                            data-shift-type="{{ mapping.default_shift_type }}"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#editMappingModal"
                                                            title="Edit department mapping">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger delete-mapping-btn" 
                                                            data-department="{{ mapping.department }}"
                                                            title="Delete department mapping">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="bi bi-building"></i>
                                </div>
                                <h6 class="empty-title">No Department Mappings Found</h6>
                                <p class="empty-text">Click "Add Department Mapping" to configure shift assignments for your departments and start automating staff shift assignment.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions Section -->
                {% if departments %}
                <div class="salary-results-card mt-4">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-lightning"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Bulk Operations</h5>
                            <p class="card-subtitle">Apply department shift rules to existing staff members</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button class="btn btn-warning" id="bulkUpdateBtn">
                                        <i class="bi bi-arrow-repeat"></i> Update Existing Staff Shifts
                                    </button>
                                    <small class="form-text text-muted mt-2">Apply department shift rules to all existing staff members based on their departments</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button class="btn btn-info" id="previewChangesBtn">
                                        <i class="bi bi-eye"></i> Preview Changes
                                    </button>
                                    <small class="form-text text-muted mt-2">See which staff members will be affected by the bulk update operation</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </main>
        </div>
    </div>

    <!-- Add Mapping Modal -->
    <div class="modal fade" id="addMappingModal" tabindex="-1" aria-labelledby="addMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addMappingModalLabel">
                        <i class="bi bi-plus-circle"></i> Add Department Shift Mapping
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addMappingForm">
                    <div class="modal-body">
                        <!-- Department Selection Section -->
                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-building text-primary"></i> Department Information
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="addDepartment" class="form-label">
                                        <i class="bi bi-building"></i> Department *
                                    </label>
                                    <select class="form-select" id="addDepartment" name="department" required title="Select department">
                                        <option value="">Select Department</option>
                                        {% for dept in departments %}
                                        <option value="{{ dept.department }}">{{ dept.department }}</option>
                                        {% endfor %}
                                        <option value="custom">+ Add Custom Department</option>
                                    </select>
                                    <small class="form-text">Choose the department for shift assignment</small>
                                </div>
                                <div class="rule-item" id="customDepartmentDiv" style="display: none;">
                                    <label for="customDepartment" class="form-label">
                                        <i class="bi bi-building-add"></i> Custom Department Name *
                                    </label>
                                    <input type="text" class="form-control" id="customDepartment" name="custom_department" title="Enter custom department name">
                                    <small class="form-text">Enter the name for the new department</small>
                                </div>
                            </div>
                        </div>

                        <!-- Shift Type Selection Section -->
                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-clock text-info"></i> Shift Configuration
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="addShiftType" class="form-label">
                                        <i class="bi bi-clock"></i> Default Shift Type *
                                    </label>
                                    <select class="form-select" id="addShiftType" name="shift_type" required title="Select shift type">
                                        <option value="">Select Shift Type</option>
                                        <option value="general">General</option>
                                        <option value="morning">Morning</option>
                                        <option value="evening">Evening</option>
                                        <option value="night">Night</option>
                                    </select>
                                    <small class="form-text">This shift type will be automatically assigned to new staff in this department</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="bi bi-exclamation-triangle text-warning fs-5"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading text-warning">Important Note</h6>
                                    <p class="mb-0">This will set the default shift type for new staff members in this department. Existing staff shifts will not be changed automatically. Use the bulk update feature if you want to apply this to existing staff.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Add Mapping
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Mapping Modal -->
    <div class="modal fade" id="editMappingModal" tabindex="-1" aria-labelledby="editMappingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editMappingModalLabel">
                        <i class="bi bi-pencil-square"></i> Edit Department Shift Mapping
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editMappingForm">
                    <input type="hidden" id="editOriginalDepartment" name="original_department">
                    <div class="modal-body">
                        <!-- Department Information Section -->
                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-building text-primary"></i> Department Information
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="editDepartment" class="form-label">
                                        <i class="bi bi-building"></i> Department
                                    </label>
                                    <input type="text" class="form-control" id="editDepartment" name="department" readonly title="Department name (read-only)">
                                    <small class="form-text">Department name cannot be changed. Delete and create a new mapping if needed.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Shift Type Selection Section -->
                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-clock text-info"></i> Shift Configuration
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="editShiftType" class="form-label">
                                        <i class="bi bi-clock"></i> Default Shift Type *
                                    </label>
                                    <select class="form-select" id="editShiftType" name="shift_type" required title="Select shift type">
                                        <option value="general">General</option>
                                        <option value="morning">Morning</option>
                                        <option value="evening">Evening</option>
                                        <option value="night">Night</option>
                                    </select>
                                    <small class="form-text">Updated shift type will apply to new staff members in this department</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Mapping
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/department_shifts.js') }}"></script>
    <script>
        // Initialize current date display and staff count
        document.addEventListener('DOMContentLoaded', function() {
            // Update current date in sidebar footer
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                const today = new Date();
                const dateStr = today.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                currentDateElement.textContent = dateStr;
            }

            // Update total staff count in sidebar footer
            const totalStaffCountElement = document.getElementById('totalStaffCount');
            if (totalStaffCountElement) {
                // Get staff count from API
                fetch('/get_staff_count')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.count !== undefined) {
                            totalStaffCountElement.textContent = data.count;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching staff count:', error);
                    });
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '{{ url_for("logout") }}';
            }
        }
    </script>
</body>
</html>

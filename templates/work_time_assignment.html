<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Assignment - VishnoRex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/salary_management.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <style>
        /* OVERRIDE: Fix sidebar positioning for work time assignment - Higher specificity */
        .container-fluid {
            padding: 0;
            margin: 0;
        }
        
        .row {
            margin: 0;
            height: fit-content !important;
            min-height: unset !important;
            display: flex;
            flex-wrap: nowrap;
        }
        
        /* Sidebar positioning - Match staff management exactly */
        .enhanced-sidebar {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 250px; /* Fixed width instead of percentage */
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            display: block !important; /* Override inline style */
        }
        
        /* Main content positioning - Match staff management */
        .salary-main-content {
            margin-left: 250px !important; /* Match sidebar width exactly */
            width: calc(100% - 250px) !important; /* Fill remaining space */
            min-height: 100vh;
            padding: 2rem 1rem;
            overflow-x: hidden;
        }
        
        /* Remove Bootstrap default spacing that causes issues */
        .col-md-2, .col-md-10 {
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Mobile responsive fixes - Match staff management */
        @media (max-width: 767.98px) {
            .enhanced-sidebar {
                position: fixed !important;
                top: 0;
                left: -100%;
                width: 280px;
                height: 100vh;
                overflow: hidden !important;
                transition: left 0.3s ease;
                z-index: 1050;
                display: none !important; /* Hidden by default on mobile */
            }
            
            .enhanced-sidebar.show {
                left: 0;
                display: block !important;
            }
            
            .salary-main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding: 1rem 0.5rem;
                padding-top: 4rem; /* Account for mobile toggle button */
            }
            
            .sidebar-toggle {
                display: block !important;
            }
        }
        
        /* Ensure sidebar toggle is properly styled - Match staff management */
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1100;
            background: var(--primary-color, #007bff);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 1.25rem;
            display: none;
        }

        /* Work Time Assignment specific styles */
        .timing-cards {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .timing-card {
            flex: 1;
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1.5rem;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        .timing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .check-out-card {
            border-left-color: #17a2b8;
        }

        .timing-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .timing-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .timing-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .time-config-form {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-save-timing {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-save-timing:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-reset-timing {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }

        .validation-message {
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .timing-cards {
                flex-direction: column;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }

        /* Enhanced card styling */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .card-header {
            border-radius: 12px 12px 0 0 !important;
            border-bottom: none;
            padding: 1.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Holiday Management Styles */
        .holiday-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .control-title {
            color: #495057;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weekly-off-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }

        .additional-days select {
            max-height: 120px;
            overflow-y: auto;
        }

        /* Holiday Calendar Styles */
        .holiday-calendar-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-container {
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #holidayCalendar {
            height: 500px;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            display: inline-block;
        }

        .legend-color.institution-wide {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .legend-color.department-specific {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .legend-color.common-leave {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
        }

        /* Holiday List Styles */
        .holiday-list-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .holiday-items-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .holiday-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .holiday-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .holiday-item.institution-wide {
            border-left: 4px solid #28a745;
        }

        .holiday-item.department-specific {
            border-left: 4px solid #ffc107;
        }

        .holiday-item.common-leave {
            border-left: 4px solid #17a2b8;
        }

        .holiday-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .holiday-dates {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .holiday-actions {
            display: flex;
            gap: 0.5rem;
        }

        .holiday-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        /* FullCalendar Custom Styling */
        .fc-event.holiday-event {
            border-radius: 6px;
            padding: 2px 4px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .fc-event.institution-wide {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-color: #28a745;
        }

        .fc-event.department-specific {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            border-color: #ffc107;
            color: #212529;
        }

        .fc-event.common-leave {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
            border-color: #17a2b8;
        }

        /* Holiday Form Styles */
        #holidayModal .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        #holidayModal .modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            border-bottom: none;
        }

        #holidayModal .form-label {
            font-weight: 600;
            color: #374151;
        }

        #holidayModal .form-control, #holidayModal .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        #holidayModal .form-control:focus, #holidayModal .form-select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Delete Modal Styles */
        #deleteHolidayModal .modal-header {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .holiday-controls {
                padding: 1rem;
            }
            
            .row .col-md-8, .row .col-md-4 {
                margin-bottom: 2rem;
            }
            
            .calendar-legend {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #holidayCalendar {
                height: 400px;
            }
        }

        /* Animation Classes */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .holiday-item {
            animation: slideInUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Mobile Sidebar Toggle -->
    <button type="button" class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar menu" aria-expanded="false" aria-controls="enhanced-sidebar">
        <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
        <div class="row">
            <!-- Enhanced Sidebar -->
            <nav class="col-md-2 enhanced-sidebar" id="enhanced-sidebar">
                <div class="sidebar-header">
                    <div class="brand-logo">
                        <div class="logo-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="brand-text">
                            <h6 class="brand-title">VishnoRex</h6>
                            <small class="brand-subtitle">Admin Panel</small>
                        </div>
                    </div>
                </div>

                <div class="sidebar-content">
                    <!-- User Profile Section -->
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ session.get('full_name', 'Admin User') }}</div>
                            <div class="user-role">Administrator</div>
                        </div>
                    </div>

                    <!-- Navigation Menu -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Main Menu</span>
                        </div>
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/dashboard">
                                    <div class="nav-icon">
                                        <i class="bi bi-house-door"></i>
                                    </div>
                                    <span class="nav-text">Dashboard</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('staff_management') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-people"></i>
                                    </div>
                                    <span class="nav-text">Staff Management</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('work_time_assignment') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-clock-history"></i>
                                    </div>
                                    <span class="nav-text">Work Time Assignment</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('salary_management') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-currency-dollar"></i>
                                    </div>
                                    <span class="nav-text">Salary Management</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/admin/reports">
                                    <div class="nav-icon">
                                        <i class="bi bi-graph-up"></i>
                                    </div>
                                    <span class="nav-text">Reports & Analytics</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#biometricDeviceModal">
                                    <div class="nav-icon">
                                        <i class="bi bi-fingerprint"></i>
                                    </div>
                                    <span class="nav-text">Biometric Device</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <div class="sidebar-footer">
                    <div class="footer-stats">
                        <div class="stat-item">
                            <i class="bi bi-people"></i>
                            <span id="totalStaffCount">{{ total_staff_count|default("-") }}</span>
                        </div>
                        <div class="stat-item">
                            <i class="bi bi-calendar-day"></i>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <button type="button" class="logout-btn" onclick="logout()" title="Logout" aria-label="Logout from work time assignment">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>
            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto px-md-4 salary-main-content">
                <!-- CSRF Token for AJAX requests -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Enhanced Header -->
                <div class="salary-header">
                    <div class="header-content">
                        <div class="header-title">
                            <div class="title-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="title-text">
                                <h1 class="main-title">Work Time Assignment</h1>
                                <p class="subtitle">Set and manage default check-in and check-out times for the institution</p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-outline-primary" id="refreshTimingBtn" title="Refresh timing data">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-success" id="exportTimingBtn" title="Export timing configuration">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Work Time Assignment Section -->
                <div class="salary-results-card">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Institution Timing Configuration</h5>
                            <p class="card-subtitle">Configure default working hours for your institution</p>
                        </div>
                        <div class="header-actions">
                            <div class="results-stats">
                                <div class="stat-item">
                                    <i class="bi bi-gear"></i>
                                    <span class="stat-value">Config</span>
                                    <span>Settings</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Current Timings Display -->
                            <div class="col-md-6">
                                <div class="current-timings-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-info-circle text-primary"></i> Current Institution Timings
                                    </h6>
                                    <div class="timing-cards">
                                        <div class="timing-card check-in-card">
                                            <div class="timing-icon">
                                                <i class="bi bi-box-arrow-in-right text-success"></i>
                                            </div>
                                            <div class="timing-info">
                                                <div class="timing-label">Institution Check-in Time</div>
                                                <div class="timing-value" id="currentCheckinTime">09:00 AM</div>
                                            </div>
                                        </div>
                                        <div class="timing-card check-out-card">
                                            <div class="timing-icon">
                                                <i class="bi bi-box-arrow-right text-info"></i>
                                            </div>
                                            <div class="timing-info">
                                                <div class="timing-label">Institution Check-out Time</div>
                                                <div class="timing-value" id="currentCheckoutTime">05:00 PM</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Time Configuration Form -->
                            <div class="col-md-6">
                                <div class="time-config-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-pencil-square text-warning"></i> Update Institution Timings
                                    </h6>
                                    <form id="workTimeForm" class="time-config-form">
                                        <div class="mb-4">
                                            <label for="institutionCheckinTime" class="form-label">
                                                <i class="bi bi-sunrise"></i> Institution Check-in Time
                                            </label>
                                            <input type="time" class="form-control time-picker" id="institutionCheckinTime" name="checkin_time" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i> Default time when staff should check in
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <label for="institutionCheckoutTime" class="form-label">
                                                <i class="bi bi-sunset"></i> Institution Check-out Time
                                            </label>
                                            <input type="time" class="form-control time-picker" id="institutionCheckoutTime" name="checkout_time" required>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle"></i> Default time when staff should check out
                                            </div>
                                        </div>
                                        <div class="validation-message" id="timeValidationMessage" style="display: none;">
                                            <div class="alert alert-danger">
                                                <i class="bi bi-exclamation-triangle"></i> Check-out time must be later than check-in time!
                                            </div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn btn-primary btn-save-timing" id="saveTimingBtn">
                                                <i class="bi bi-check-circle"></i> Save & Update Timings
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-reset-timing" id="resetTimingBtn">
                                                <i class="bi bi-arrow-clockwise"></i> Reset to Default
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Success/Error Messages -->
                        <div class="mt-3">
                            <div class="alert alert-success" id="timingSuccessMessage" style="display: none;">
                                <i class="bi bi-check-circle-fill"></i> Institution timings updated successfully!
                            </div>
                            <div class="alert alert-danger" id="timingErrorMessage" style="display: none;">
                                <i class="bi bi-exclamation-triangle-fill"></i> <span id="errorMessageText">Failed to update timings. Please try again.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Holiday Management Section -->
                <div class="salary-results-card mt-4">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                        <div class="header-content">
                            <h5 class="card-title">Holiday Management System</h5>
                            <p class="card-subtitle">Manage institutional holidays, common leaves, and weekly offs</p>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-primary" id="addHolidayBtn">
                                <i class="bi bi-calendar-plus"></i> Add Holiday
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Holiday Management Controls -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="holiday-controls">
                                    <div class="control-group">
                                        <h6 class="control-title">
                                            <i class="bi bi-calendar-week text-info"></i> Weekly Off Configuration
                                        </h6>
                                        <div class="weekly-off-controls">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="sundayOffEnabled" checked>
                                                <label class="form-check-label" for="sundayOffEnabled">
                                                    Sunday as Weekly Off
                                                </label>
                                            </div>
                                            <div class="additional-days mt-2">
                                                <label class="form-label">Additional Weekly Off Days:</label>
                                                <select class="form-select" id="additionalOffDays" multiple>
                                                    <option value="monday">Monday</option>
                                                    <option value="tuesday">Tuesday</option>
                                                    <option value="wednesday">Wednesday</option>
                                                    <option value="thursday">Thursday</option>
                                                    <option value="friday">Friday</option>
                                                    <option value="saturday">Saturday</option>
                                                </select>
                                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple days</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Holiday Calendar and List -->
                        <div class="row">
                            <!-- Holiday Calendar -->
                            <div class="col-md-8">
                                <div class="holiday-calendar-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-calendar3 text-primary"></i> Holiday Calendar View
                                    </h6>
                                    <div class="calendar-container">
                                        <div id="holidayCalendar"></div>
                                    </div>
                                    <div class="calendar-legend mt-3">
                                        <div class="legend-item">
                                            <span class="legend-color institution-wide"></span>
                                            <span class="legend-text">Institution-wide Holidays</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-color department-specific"></span>
                                            <span class="legend-text">Department-specific Holidays</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-color common-leave"></span>
                                            <span class="legend-text">Common Leave Days</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Holiday List -->
                            <div class="col-md-4">
                                <div class="holiday-list-section">
                                    <h6 class="section-title">
                                        <i class="bi bi-list-check text-success"></i> Holiday List
                                    </h6>
                                    
                                    <!-- Loading and Messages -->
                                    <div class="text-center py-3" id="holidaysLoading" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading holidays...</span>
                                        </div>
                                        <div class="mt-2">Loading holidays...</div>
                                    </div>
                                    
                                    <div class="alert alert-info" id="noHolidaysMessage" style="display: none;">
                                        <i class="bi bi-info-circle"></i> No holidays configured yet. Click "Add Holiday" to get started.
                                    </div>

                                    <!-- Holiday Items Container -->
                                    <div id="holidaysList" class="holiday-items-container">
                                        <!-- Holiday items will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Holiday Success/Error Messages -->
                        <div class="mt-3">
                            <div class="alert alert-success" id="holidaySuccessMessage" style="display: none;">
                                <i class="bi bi-check-circle-fill"></i> <span id="holidaySuccessText">Holiday operation completed successfully!</span>
                            </div>
                            <div class="alert alert-danger" id="holidayErrorMessage" style="display: none;">
                                <i class="bi bi-exclamation-triangle-fill"></i> <span id="holidayErrorText">Holiday operation failed. Please try again.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Holiday Management Modals -->
                
                <!-- Add/Edit Holiday Modal -->
                <div class="modal fade" id="holidayModal" tabindex="-1" aria-labelledby="holidayModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="holidayModalLabel">
                                    <i class="bi bi-calendar-plus"></i> Add Holiday
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="holidayForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="holidayName" class="form-label">Holiday Name *</label>
                                                <input type="text" class="form-control" id="holidayName" name="holiday_name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="holidayType" class="form-label">Holiday Type *</label>
                                                <select class="form-select" id="holidayType" name="holiday_type" required>
                                                    <option value="institution_wide">Institution-wide Holiday</option>
                                                    <option value="department_specific">Department-specific Holiday</option>
                                                    <option value="common_leave">Common Leave Day</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="startDate" class="form-label">Start Date *</label>
                                                <input type="date" class="form-control" id="startDate" name="start_date" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="endDate" class="form-label">End Date *</label>
                                                <input type="date" class="form-control" id="endDate" name="end_date" required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Department Selection (for department-specific holidays) -->
                                    <div class="mb-3" id="departmentsSection" style="display: none;">
                                        <label for="departments" class="form-label">Select Departments *</label>
                                        <select class="form-select" id="departments" name="departments" multiple size="4">
                                            <!-- Department options will be populated via JavaScript -->
                                        </select>
                                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple departments</small>
                                    </div>

                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="3" placeholder="Optional description for this holiday"></textarea>
                                    </div>

                                    <!-- Recurring Holiday Options -->
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isRecurring" name="is_recurring">
                                            <label class="form-check-label" for="isRecurring">
                                                Recurring Holiday (appears every year)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3" id="recurringTypeSection" style="display: none;">
                                        <label for="recurringType" class="form-label">Recurring Pattern</label>
                                        <select class="form-select" id="recurringType" name="recurring_type">
                                            <option value="yearly">Every Year (same date)</option>
                                            <option value="monthly">Every Month (same day)</option>
                                            <option value="weekly">Every Week (same day of week)</option>
                                        </select>
                                    </div>

                                    <!-- Salary Impact Notice -->
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Salary Impact:</strong> Staff salaries will NOT be deducted for days marked as holidays or common leave.
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveHolidayBtn">
                                    <i class="bi bi-check-circle"></i> Save Holiday
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Holiday Confirmation Modal -->
                <div class="modal fade" id="deleteHolidayModal" tabindex="-1" aria-labelledby="deleteHolidayModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteHolidayModalLabel">
                                    <i class="bi bi-exclamation-triangle text-danger"></i> Delete Holiday
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete the holiday "<strong id="deleteHolidayName"></strong>"?</p>
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Warning:</strong> This action cannot be undone. The holiday will be removed from all staff calendars and attendance calculations.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteHolidayBtn">
                                    <i class="bi bi-trash"></i> Delete Holiday
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script>
        // Enhanced sidebar functionality matching staff management
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 WORK TIME ASSIGNMENT: Fixed sidebar initialization...');
            
            // Mobile sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('enhanced-sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', function() {
                    console.log('🔄 WORK TIME ASSIGNMENT - Toggle clicked!');
                    sidebar.classList.toggle('show');
                    
                    // Update aria-expanded
                    const isExpanded = sidebar.classList.contains('show');
                    sidebarToggle.setAttribute('aria-expanded', isExpanded);
                });

                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 767.98 && sidebar.classList.contains('show')) {
                        if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target)) {
                            sidebar.classList.remove('show');
                            sidebarToggle.setAttribute('aria-expanded', 'false');
                        }
                    }
                });

                // Handle window resize
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 767.98) {
                        sidebar.classList.remove('show');
                        sidebarToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
            
            console.log('✅ WORK TIME ASSIGNMENT fixed sidebar initialized successfully');
            
            // Load current institution timings on page load
            loadCurrentTimings();
        });

        // Helper function to get CSRF token (similar to admin dashboard)
        function getCSRFToken() {
            const token = document.querySelector('input[name="csrf_token"]');
            return token ? token.value : '';
        }

        // Helper function to check session status
        function checkSessionStatus() {
            return fetch('/api/debug_session', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Session status:', data);
                return data.success && data.session_data.has_session;
            })
            .catch(error => {
                console.error('Error checking session:', error);
                return false;
            });
        }

        // Helper function to test timing synchronization
        function testTimingSync() {
            fetch('/api/test_timing_sync', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Timing Sync Test Results:', data.sync_check);
                    if (data.sync_check.systems_synced) {
                        console.log('✅ All systems are synchronized with institution timings');
                    } else {
                        console.warn('⚠️ Systems may not be fully synchronized');
                    }
                } else {
                    console.error('❌ Sync test failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error testing sync:', error);
            });
        }

        // Function to load current timings from API
        function loadCurrentTimings() {
            fetch('/api/get_institution_timings', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'  // Include session cookies
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const checkinTime = data.checkin_time || '09:00';
                    const checkoutTime = data.checkout_time || '17:00';
                    
                    // Update form inputs
                    document.getElementById('institutionCheckinTime').value = checkinTime;
                    document.getElementById('institutionCheckoutTime').value = checkoutTime;
                    
                    // Update display cards
                    document.getElementById('currentCheckinTime').textContent = convertTo12Hour(checkinTime);
                    document.getElementById('currentCheckoutTime').textContent = convertTo12Hour(checkoutTime);
                } else {
                    console.error('API returned error:', data.message);
                    setDefaultTimings();
                }
            })
            .catch(error => {
                console.error('Error loading timings:', error);
                setDefaultTimings();
            });
        }

        // Helper function to set default timings
        function setDefaultTimings() {
            document.getElementById('institutionCheckinTime').value = '09:00';
            document.getElementById('institutionCheckoutTime').value = '17:00';
            document.getElementById('currentCheckinTime').textContent = '09:00 AM';
            document.getElementById('currentCheckoutTime').textContent = '05:00 PM';
        }

        // Work time form functionality
        document.getElementById('workTimeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const checkinTime = document.getElementById('institutionCheckinTime').value;
            const checkoutTime = document.getElementById('institutionCheckoutTime').value;
            
            // Validate times
            if (checkinTime >= checkoutTime) {
                document.getElementById('timeValidationMessage').style.display = 'block';
                return;
            } else {
                document.getElementById('timeValidationMessage').style.display = 'none';
            }
            
            // Show loading state
            const saveBtn = document.getElementById('saveTimingBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bi bi-spinner-grow spinner-grow-sm"></i> Saving...';
            saveBtn.disabled = true;

            try {
                // Check session status first
                const hasValidSession = await checkSessionStatus();
                if (!hasValidSession) {
                    alert('Session expired. Please log in as admin and try again.');
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }

                // Prepare form data
                const formData = new FormData();
                formData.append('checkin_time', checkinTime);
                formData.append('checkout_time', checkoutTime);
                
                // Add CSRF token if available
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    formData.append('csrf_token', csrfToken);
                }

                // Make actual API call
                const response = await fetch('/api/update_institution_timings', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'  // Include session cookies
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Unauthorized: Please log in as admin');
                    } else if (response.status === 400) {
                        throw new Error('Bad request: Invalid data submitted');
                    } else if (response.status === 500) {
                        throw new Error('Server error: Please try again later');
                    } else {
                        throw new Error(`HTTP Error ${response.status}: ${response.statusText}`);
                    }
                }

                const data = await response.json();

                if (data.success) {
                    // Update display times
                    const checkinDisplay = convertTo12Hour(checkinTime);
                    const checkoutDisplay = convertTo12Hour(checkoutTime);
                    
                    document.getElementById('currentCheckinTime').textContent = checkinDisplay;
                    document.getElementById('currentCheckoutTime').textContent = checkoutDisplay;
                    
                    // Show enhanced success message with sync confirmation
                    const successMsg = document.getElementById('timingSuccessMessage');
                    successMsg.innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle-fill"></i> Institution Timings Updated Successfully!</h6>
                            <p class="mb-2">
                                <strong>New Timings:</strong> ${checkinDisplay} - ${checkoutDisplay}
                            </p>
                            <small class="text-muted">
                                <i class="bi bi-sync"></i> These timings are now active across the entire system:
                                <br>• Staff attendance calculations
                                <br>• Biometric device processing
                                <br>• Late/early departure detection
                                <br>• Reporting and analytics
                            </small>
                        </div>
                    `;
                    successMsg.style.display = 'block';
                    
                    // Auto-hide success message after 8 seconds
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 8000);
                    
                    // Test sync after a short delay
                    setTimeout(() => {
                        testTimingSync();
                    }, 1000);
                } else {
                    // Show error message with specific details
                    const errorMsg = data.message || 'Unknown error occurred';
                    alert('Failed to update timings: ' + errorMsg);
                    console.error('API Error:', data);
                }
                
            } catch (error) {
                console.error('Error updating timings:', error);
                
                // More specific error handling with debugging info
                let errorMessage = 'Network error. Please try again.';
                console.log('Full error details:', error);
                
                if (error.message.includes('Unauthorized')) {
                    errorMessage = 'Please log in as admin to update institution timings.';
                } else if (error.message.includes('Bad request')) {
                    errorMessage = 'Invalid time format. Please check your input.';
                } else if (error.message.includes('Server error')) {
                    errorMessage = 'Server error. Please try again later.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Connection failed. Please check your internet connection.';
                } else if (error.name === 'TypeError') {
                    errorMessage = 'Request failed. Please ensure you are logged in as admin.';
                }
                
                alert(errorMessage + '\n\nTechnical details: ' + error.message);
            } finally {
                // Reset button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        });
        
        // Reset form
        document.getElementById('resetTimingBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to reset to current saved timings?')) {
                loadCurrentTimings();
                document.getElementById('timeValidationMessage').style.display = 'none';
            }
        });

        // Header action buttons
        document.getElementById('refreshTimingBtn').addEventListener('click', function() {
            loadCurrentTimings();
        });

        document.getElementById('exportTimingBtn').addEventListener('click', function() {
            // Simulate export functionality
            const data = {
                checkin_time: document.getElementById('currentCheckinTime').textContent,
                checkout_time: document.getElementById('currentCheckoutTime').textContent,
                export_date: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'work_time_configuration.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // Convert 24-hour to 12-hour format
        function convertTo12Hour(time24) {
            const [hour, minute] = time24.split(':');
            const hour12 = hour % 12 || 12;
            const ampm = hour < 12 ? 'AM' : 'PM';
            return `${hour12}:${minute} ${ampm}`;
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        /* ===============================================
         * HOLIDAY MANAGEMENT SYSTEM
         * =============================================== */

        // Holiday Management Global Variables
        let holidayCalendar;
        let currentHolidays = [];
        let editingHolidayId = null;
        let weeklyOffDays = ['sunday']; // Default weekly off

        // Initialize Holiday Management System
        function initializeHolidayManagement() {
            console.log('🎄 Initializing Holiday Management System...');

            try {
                // Initialize holiday calendar
                initializeHolidayCalendar();
                
                // Setup event listeners
                setupHolidayEventListeners();
                
                // Load existing holidays
                loadHolidays();
                
                // Load departments for dropdown
                loadDepartments();
                
                // Load weekly off configuration
                loadWeeklyOffConfiguration();
                
                console.log('✅ Holiday Management System initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing Holiday Management:', error);
                showHolidayError('Failed to initialize Holiday Management System');
            }
        }

        // Initialize FullCalendar for Holiday Management
        function initializeHolidayCalendar() {
            const calendarEl = document.getElementById('holidayCalendar');
            
            if (!calendarEl) {
                console.warn('⚠️ Holiday calendar element not found');
                return;
            }

            holidayCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                height: 500,
                events: function(fetchInfo, successCallback, failureCallback) {
                    try {
                        // Convert holidays to calendar events
                        const events = currentHolidays.map(holiday => ({
                            id: holiday.id,
                            title: holiday.holiday_name,
                            start: holiday.start_date,
                            end: holiday.end_date,
                            className: `holiday-event ${holiday.holiday_type.replace('_', '-')}`,
                            extendedProps: {
                                holiday_type: holiday.holiday_type,
                                description: holiday.description,
                                departments: holiday.departments || []
                            }
                        }));
                        
                        console.log(`📅 Rendering ${events.length} holiday events`);
                        successCallback(events);
                    } catch (error) {
                        console.error('❌ Error processing holiday events:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function(info) {
                    showHolidayDetails(info.event);
                },
                eventDidMount: function(info) {
                    // Add tooltips to calendar events
                    info.el.title = `${info.event.title}\nType: ${info.event.extendedProps.holiday_type.replace('_', ' ')}\nClick for details`;
                }
            });

            holidayCalendar.render();
        }

        // Setup Holiday Management Event Listeners
        function setupHolidayEventListeners() {
            // Add Holiday button
            document.getElementById('addHolidayBtn')?.addEventListener('click', function() {
                openHolidayModal();
            });

            // Holiday type change event
            document.getElementById('holidayType')?.addEventListener('change', function() {
                toggleDepartmentsSection();
            });

            // Recurring checkbox event
            document.getElementById('isRecurring')?.addEventListener('change', function() {
                toggleRecurringSection();
            });

            // Save Holiday button
            document.getElementById('saveHolidayBtn')?.addEventListener('click', function() {
                saveHoliday();
            });

            // Delete Holiday confirmation
            document.getElementById('confirmDeleteHolidayBtn')?.addEventListener('click', function() {
                confirmDeleteHoliday();
            });

            // Weekly off configuration
            document.getElementById('sundayOffEnabled')?.addEventListener('change', function() {
                updateWeeklyOffConfiguration();
            });

            document.getElementById('additionalOffDays')?.addEventListener('change', function() {
                updateWeeklyOffConfiguration();
            });
        }

        // Load Holidays from API
        function loadHolidays() {
            console.log('📋 Loading holidays...');

            const loadingEl = document.getElementById('holidaysLoading');
            const noHolidaysEl = document.getElementById('noHolidaysMessage');

            if (loadingEl) loadingEl.style.display = 'block';
            if (noHolidaysEl) noHolidaysEl.style.display = 'none';

            fetch('/api/holidays', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('📋 Holidays API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📋 Holidays API response data:', data);
                if (data.success) {
                    currentHolidays = data.holidays || [];
                    console.log(`📋 Loaded ${currentHolidays.length} holidays`);
                    displayHolidaysList();
                    updateHolidayCalendar();
                } else {
                    const message = data.message || 'Unknown error';
                    console.error('❌ API returned error:', message);
                    showHolidayError('Failed to load holidays: ' + message);
                    currentHolidays = [];
                    displayHolidaysList();
                }
            })
            .catch(error => {
                console.error('❌ Error loading holidays:', error);
                showHolidayError('Failed to load holidays. Please check your connection and try again.');
                currentHolidays = [];
                displayHolidaysList();
            })
            .finally(() => {
                if (loadingEl) loadingEl.style.display = 'none';
            });
        }

        // Display Holidays List
        function displayHolidaysList() {
            const holidaysList = document.getElementById('holidaysList');
            const noHolidaysEl = document.getElementById('noHolidaysMessage');

            if (!holidaysList) return;

            if (currentHolidays.length === 0) {
                holidaysList.innerHTML = '';
                if (noHolidaysEl) noHolidaysEl.style.display = 'block';
                return;
            }

            if (noHolidaysEl) noHolidaysEl.style.display = 'none';

            holidaysList.innerHTML = currentHolidays.map(holiday => {
                const startDate = new Date(holiday.start_date).toLocaleDateString();
                const endDate = new Date(holiday.end_date).toLocaleDateString();
                const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;

                const typeClass = holiday.holiday_type.replace('_', '-');
                let typeBadge = '';
                
                switch (holiday.holiday_type) {
                    case 'institution_wide':
                        typeBadge = '<span class="badge bg-success holiday-type-badge">Institution-wide</span>';
                        break;
                    case 'department_specific':
                        typeBadge = '<span class="badge bg-warning holiday-type-badge">Department-specific</span>';
                        break;
                    case 'common_leave':
                        typeBadge = '<span class="badge bg-info holiday-type-badge">Common Leave</span>';
                        break;
                    default:
                        typeBadge = '<span class="badge bg-secondary holiday-type-badge">Unknown</span>';
                }

                const departmentInfo = holiday.holiday_type === 'department_specific' && holiday.departments && holiday.departments.length > 0
                    ? `<div class="text-muted small mt-1"><i class="bi bi-people"></i> ${holiday.departments.join(', ')}</div>`
                    : '';

                const description = holiday.description 
                    ? `<div class="text-muted small mt-1"><i class="bi bi-info-circle"></i> ${holiday.description}</div>`
                    : '';

                return `
                    <div class="holiday-item ${typeClass}" data-holiday-id="${holiday.id}">
                        <div class="holiday-name">${holiday.holiday_name}</div>
                        <div class="holiday-dates">
                            <i class="bi bi-calendar-date"></i> ${dateRange}
                        </div>
                        ${departmentInfo}
                        ${description}
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            ${typeBadge}
                            <div class="holiday-actions">
                                <button class="btn btn-outline-primary btn-sm" onclick="editHoliday(${holiday.id})" title="Edit Holiday">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteHoliday(${holiday.id}, '${holiday.holiday_name.replace(/'/g, '\\\'')}')" title="Delete Holiday">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update Holiday Calendar
        function updateHolidayCalendar() {
            if (holidayCalendar) {
                holidayCalendar.refetchEvents();
            }
        }

        // Load Departments for Dropdown
        function loadDepartments() {
            fetch('/api/departments', {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const departmentsSelect = document.getElementById('departments');
                    if (departmentsSelect) {
                        departmentsSelect.innerHTML = data.departments.map(dept =>
                            `<option value="${dept}">${dept}</option>`
                        ).join('');
                    }
                }
            })
            .catch(error => {
                console.error('❌ Error loading departments:', error);
            });
        }

        // Open Holiday Modal (Add/Edit)
        function openHolidayModal(holiday = null) {
            const modal = new bootstrap.Modal(document.getElementById('holidayModal'));
            const modalTitle = document.getElementById('holidayModalLabel');
            const saveBtn = document.getElementById('saveHolidayBtn');
            
            // Reset form
            document.getElementById('holidayForm').reset();
            editingHolidayId = holiday ? holiday.id : null;

            if (holiday) {
                modalTitle.innerHTML = '<i class="bi bi-pencil"></i> Edit Holiday';
                saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Update Holiday';

                // Populate form with holiday data
                document.getElementById('holidayName').value = holiday.holiday_name || '';
                document.getElementById('holidayType').value = holiday.holiday_type || 'institution_wide';
                document.getElementById('startDate').value = holiday.start_date || '';
                document.getElementById('endDate').value = holiday.end_date || '';
                document.getElementById('description').value = holiday.description || '';
                document.getElementById('isRecurring').checked = holiday.is_recurring || false;
                document.getElementById('recurringType').value = holiday.recurring_type || 'yearly';

                // Handle departments for department-specific holidays
                if (holiday.holiday_type === 'department_specific' && holiday.departments) {
                    setTimeout(() => {
                        const departmentsSelect = document.getElementById('departments');
                        if (departmentsSelect) {
                            Array.from(departmentsSelect.options).forEach(option => {
                                option.selected = holiday.departments.includes(option.value);
                            });
                        }
                    }, 100);
                }
            } else {
                modalTitle.innerHTML = '<i class="bi bi-calendar-plus"></i> Add Holiday';
                saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Holiday';
            }

            // Show/hide relevant sections
            toggleDepartmentsSection();
            toggleRecurringSection();
            
            modal.show();
        }

        // Toggle Departments Section
        function toggleDepartmentsSection() {
            const holidayType = document.getElementById('holidayType')?.value;
            const departmentsSection = document.getElementById('departmentsSection');
            
            if (departmentsSection) {
                departmentsSection.style.display = holidayType === 'department_specific' ? 'block' : 'none';
            }
        }

        // Toggle Recurring Section
        function toggleRecurringSection() {
            const isRecurring = document.getElementById('isRecurring')?.checked;
            const recurringTypeSection = document.getElementById('recurringTypeSection');
            
            if (recurringTypeSection) {
                recurringTypeSection.style.display = isRecurring ? 'block' : 'none';
            }
        }

        // Save Holiday
        function saveHoliday() {
            const form = document.getElementById('holidayForm');

            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Additional validation
            const holidayName = document.getElementById('holidayName').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!holidayName) {
                showHolidayError('Holiday name is required');
                return;
            }

            if (!startDate || !endDate) {
                showHolidayError('Start date and end date are required');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showHolidayError('Start date cannot be after end date');
                return;
            }

            const formData = new FormData(form);

            // Add CSRF token
            const csrfToken = getCSRFToken();
            if (csrfToken) {
                formData.append('csrf_token', csrfToken);
            }

            // Handle departments for department-specific holidays
            const holidayType = formData.get('holiday_type');
            if (holidayType === 'department_specific') {
                const selectedDepartments = Array.from(document.getElementById('departments').selectedOptions)
                    .map(option => option.value);

                if (selectedDepartments.length === 0) {
                    showHolidayError('Please select at least one department for department-specific holidays');
                    return;
                }

                // Clear existing departments entries
                formData.delete('departments');
                // Add selected departments
                selectedDepartments.forEach(dept => {
                    formData.append('departments', dept);
                });
            }

            const saveBtn = document.getElementById('saveHolidayBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="bi bi-spinner-grow spinner-grow-sm"></i> Saving...';
            saveBtn.disabled = true;

            const url = editingHolidayId ? `/api/holidays/${editingHolidayId}` : '/api/holidays';
            const method = editingHolidayId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const message = data.message || 'Holiday saved successfully';
                    showHolidaySuccess(message);
                    loadHolidays();

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('holidayModal'));
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    const errorMessage = data.message || data.error || 'Failed to save holiday';
                    showHolidayError(errorMessage);
                }
            })
            .catch(error => {
                console.error('❌ Error saving holiday:', error);
                showHolidayError(`Failed to save holiday: ${error.message}`);
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Edit Holiday
        function editHoliday(holidayId) {
            const holiday = currentHolidays.find(h => h.id === holidayId);
            if (holiday) {
                openHolidayModal(holiday);
            }
        }

        // Delete Holiday
        function deleteHoliday(holidayId, holidayName) {
            document.getElementById('deleteHolidayName').textContent = holidayName;
            editingHolidayId = holidayId;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteHolidayModal'));
            modal.show();
        }

        // Confirm Delete Holiday
        function confirmDeleteHoliday() {
            if (!editingHolidayId) return;

            const deleteBtn = document.getElementById('confirmDeleteHolidayBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="bi bi-spinner-grow spinner-grow-sm"></i> Deleting...';
            deleteBtn.disabled = true;

            fetch(`/api/holidays/${editingHolidayId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showHolidaySuccess('Holiday deleted successfully');
                    loadHolidays();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteHolidayModal'));
                    if (modal) {
                        modal.hide();
                    }
                } else {
                    showHolidayError(data.message || 'Failed to delete holiday');
                }
            })
            .catch(error => {
                console.error('❌ Error deleting holiday:', error);
                showHolidayError('Failed to delete holiday');
            })
            .finally(() => {
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
                editingHolidayId = null;
            });
        }

        // Show Holiday Details
        function showHolidayDetails(event) {
            const holiday = currentHolidays.find(h => h.id == event.id);
            if (holiday) {
                const startDate = new Date(holiday.start_date).toLocaleDateString();
                const endDate = new Date(holiday.end_date).toLocaleDateString();
                const dateRange = startDate === endDate ? startDate : `${startDate} - ${endDate}`;
                
                let typeText = '';
                switch (holiday.holiday_type) {
                    case 'institution_wide':
                        typeText = 'Institution-wide Holiday';
                        break;
                    case 'department_specific':
                        typeText = 'Department-specific Holiday';
                        break;
                    case 'common_leave':
                        typeText = 'Common Leave Day';
                        break;
                    default:
                        typeText = 'Holiday';
                }

                let details = `${holiday.holiday_name}\n${typeText}\n${dateRange}`;
                
                if (holiday.description) {
                    details += `\n\nDescription: ${holiday.description}`;
                }
                
                if (holiday.holiday_type === 'department_specific' && holiday.departments && holiday.departments.length > 0) {
                    details += `\n\nDepartments: ${holiday.departments.join(', ')}`;
                }

                alert(details);
            }
        }

        // Load Weekly Off Configuration
        function loadWeeklyOffConfiguration() {
            // This would typically load from API, for now set defaults
            const sundayOffEnabled = document.getElementById('sundayOffEnabled');
            const additionalOffDays = document.getElementById('additionalOffDays');
            
            if (sundayOffEnabled) {
                sundayOffEnabled.checked = weeklyOffDays.includes('sunday');
            }
        }

        // Update Weekly Off Configuration
        function updateWeeklyOffConfiguration() {
            const sundayOffEnabled = document.getElementById('sundayOffEnabled')?.checked;
            const additionalOffDays = Array.from(document.getElementById('additionalOffDays')?.selectedOptions || [])
                .map(option => option.value);

            weeklyOffDays = [];
            if (sundayOffEnabled) {
                weeklyOffDays.push('sunday');
            }
            weeklyOffDays.push(...additionalOffDays);

            console.log('📅 Updated weekly off days:', weeklyOffDays);
            
            // Here you would typically save to API
            showHolidaySuccess('Weekly off configuration updated successfully');
        }

        // Show Holiday Success Message
        function showHolidaySuccess(message) {
            const successEl = document.getElementById('holidaySuccessMessage');
            const successText = document.getElementById('holidaySuccessText');
            
            if (successEl && successText) {
                successText.textContent = message;
                successEl.style.display = 'block';
                
                // Hide error message
                const errorEl = document.getElementById('holidayErrorMessage');
                if (errorEl) errorEl.style.display = 'none';
                
                setTimeout(() => {
                    successEl.style.display = 'none';
                }, 5000);
            }
        }

        // Show Holiday Error Message
        function showHolidayError(message) {
            const errorEl = document.getElementById('holidayErrorMessage');
            const errorText = document.getElementById('holidayErrorText');
            
            if (errorEl && errorText) {
                errorText.textContent = message;
                errorEl.style.display = 'block';
                
                // Hide success message
                const successEl = document.getElementById('holidaySuccessMessage');
                if (successEl) successEl.style.display = 'none';
                
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 8000);
            }
        }

        // Initialize Holiday Management when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize both work time assignment and holiday management
            setTimeout(() => {
                initializeHolidayManagement();
            }, 500);
        });


    </script>
</body>
</html>

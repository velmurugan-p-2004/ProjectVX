<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - VishnoRex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/salary_management.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
</head>
<body>
    <!-- Mobile Sidebar Toggle -->
    <button type="button" class="sidebar-toggle d-md-none" id="sidebarToggle" title="Toggle sidebar menu">
        <i class="bi bi-list"></i>
    </button>

    <div class="container-fluid">
        <div class="row">
            <!-- Enhanced Sidebar -->
            <nav class="col-md-2 d-none d-md-block enhanced-sidebar">
                <div class="sidebar-header">
                    <div class="brand-logo">
                        <div class="logo-icon">
                            <i class="bi bi-person-workspace"></i>
                        </div>
                        <div class="brand-text">
                            <h6 class="brand-title">VishnoRex</h6>
                            <small class="brand-subtitle">Staff Panel</small>
                        </div>
                    </div>
                </div>

                <div class="sidebar-content">
                    <!-- User Profile Section -->
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ session.get('full_name', 'Staff User') }}</div>
                            <div class="user-role">Staff Member</div>
                        </div>
                    </div>

                    <!-- Navigation Menu -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Main Menu</span>
                        </div>
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('staff_dashboard') }}">
                                    <div class="nav-icon">
                                        <i class="bi bi-house-door"></i>
                                    </div>
                                    <span class="nav-text">Dashboard</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="#">
                                    <div class="nav-icon">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <span class="nav-text">My Profile</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Applications Section -->
                    <div class="nav-section">
                        <div class="nav-section-title">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Applications</span>
                        </div>
                        <ul class="nav-menu">
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                                    <div class="nav-icon">
                                        <i class="bi bi-calendar-plus"></i>
                                    </div>
                                    <span class="nav-text">Apply Leave</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#applyOnDutyModal">
                                    <div class="nav-icon">
                                        <i class="bi bi-briefcase"></i>
                                    </div>
                                    <span class="nav-text">Apply On Duty</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#applyPermissionModal">
                                    <div class="nav-icon">
                                        <i class="bi bi-clock"></i>
                                    </div>
                                    <span class="nav-text">Apply Permission</span>
                                    <div class="nav-indicator"></div>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Sidebar Footer -->
                <div class="sidebar-footer">
                    <div class="footer-stats">
                        <div class="stat-item">
                            <i class="bi bi-calendar-day"></i>
                            <span id="currentDate">-</span>
                        </div>
                    </div>
                    <button type="button" class="logout-btn" onclick="logout()" title="Logout">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-10 ms-sm-auto px-md-4 salary-main-content">
                <!-- CSRF Token for AJAX requests -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Enhanced Header -->
                <div class="salary-header">
                    <div class="header-content">
                        <div class="header-title">
                            <div class="title-icon">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="title-text">
                                <h1 class="main-title">My Profile</h1>
                                <p class="subtitle">View and manage your personal information and settings</p>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal" title="Edit profile">
                                <i class="bi bi-pencil"></i> Edit Profile
                            </button>
                            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#changePasswordModal" title="Change password">
                                <i class="bi bi-key"></i> Change Password
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Profile Information Card -->
                    <div class="col-md-4">
                        <div class="salary-results-card">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">Profile Information</h5>
                                    <p class="card-subtitle">Your personal details and information</p>
                                </div>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-4">
                                    {% if staff.photo_url %}
                                        <img src="{{ url_for('static', filename=staff.photo_url) }}" 
                                             alt="Profile Photo" class="profile-avatar-img rounded-circle" width="120" height="120">
                                    {% else %}
                                        <div class="profile-avatar-placeholder rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                             style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <i class="bi bi-person-fill text-white" style="font-size: 3rem;"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <h4 class="mb-2">{{ staff.full_name }}</h4>
                                <p class="text-muted mb-1">{{ staff.destination or staff.position or 'Not specified' }}</p>
                                <p class="text-muted mb-3">
                                    <span class="badge bg-primary">{{ staff.department or 'Not specified' }}</span>
                                </p>
                                
                                <div class="rules-section text-start">
                                    <div class="rule-item mb-2">
                                        <strong>Staff ID:</strong> <span class="text-muted">{{ staff.staff_id }}</span>
                                    </div>
                                    <div class="rule-item mb-2">
                                        <strong>Email:</strong> <span class="text-muted">{{ staff.email or 'Not provided' }}</span>
                                    </div>
                                    <div class="rule-item mb-2">
                                        <strong>Phone:</strong> <span class="text-muted">{{ staff.phone or 'Not provided' }}</span>
                                    </div>
                                    <div class="rule-item mb-2">
                                        <strong>Gender:</strong> <span class="text-muted">{{ staff.gender or 'Not provided' }}</span>
                                    </div>
                                    <div class="rule-item mb-2">
                                        <strong>Date of Birth:</strong> <span class="text-muted">{{ staff.date_of_birth or 'Not provided' }}</span>
                                    </div>
                                    <div class="rule-item mb-2">
                                        <strong>Date of Joining:</strong> <span class="text-muted">{{ staff.date_of_joining or 'Not provided' }}</span>
                                    </div>
                                    <div class="rule-item mb-3">
                                        <strong>Shift Type:</strong>
                                        <span class="badge bg-info">{{ staff.shift_type or 'General' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Summary -->
                        <div class="salary-results-card mt-4">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">{{ current_month }} Summary</h5>
                                    <p class="card-subtitle">Your attendance statistics for this month</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="filters-grid">
                                    <div class="filter-group">
                                        <div class="attendance-stat-card bg-success bg-opacity-10">
                                            <div class="stat-icon text-success">
                                                <i class="bi bi-check-circle"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-value">{{ attendance_summary.present_days or 0 }}</div>
                                                <div class="stat-label">Present</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <div class="attendance-stat-card bg-danger bg-opacity-10">
                                            <div class="stat-icon text-danger">
                                                <i class="bi bi-x-circle"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-value">{{ attendance_summary.absent_days or 0 }}</div>
                                                <div class="stat-label">Absent</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <div class="attendance-stat-card bg-warning bg-opacity-10">
                                            <div class="stat-icon text-warning">
                                                <i class="bi bi-clock"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-value">{{ attendance_summary.late_days or 0 }}</div>
                                                <div class="stat-label">Late</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="filter-group">
                                        <div class="attendance-stat-card bg-info bg-opacity-10">
                                            <div class="stat-icon text-info">
                                                <i class="bi bi-calendar-x"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-value">{{ attendance_summary.leave_days or 0 }}</div>
                                                <div class="stat-label">Leave</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <canvas id="attendanceSummaryChart" width="100%" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Attendance Details -->
                    <div class="col-md-8">
                        <!-- Weekly Attendance Calendar -->
                        <div class="salary-results-card">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">Weekly Attendance Calendar</h5>
                                    <p class="card-subtitle">Your attendance overview for the current week</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="weeklyAttendanceCalendar"></div>
                            </div>
                        </div>
                        <!-- Daily Attendance Records -->
                        <div class="salary-results-card mt-4">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">Daily Attendance Records</h5>
                                    <p class="card-subtitle">Your attendance entries (one check-in and check-out per day)</p>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if recent_verifications %}
                                {% set daily_records = {} %}
                                {% for verification in recent_verifications %}
                                    {% set date_key = verification.verification_time[:10] %}
                                    {% if date_key not in daily_records %}
                                        {% set parsed_date = verification.verification_time[:10] %}
                                        {% set _ = daily_records.update({date_key: {'date': parsed_date, 'check_in': None, 'check_out': None}}) %}
                                    {% endif %}
                                    {% if verification.verification_type == 'check-in' %}
                                        {% set _ = daily_records[date_key].update({'check_in': verification}) %}
                                    {% elif verification.verification_type == 'check-out' %}
                                        {% set _ = daily_records[date_key].update({'check_out': verification}) %}
                                    {% endif %}
                                {% endfor %}
                                
                                <div class="daily-attendance-list">
                                    {% for date_key, record in daily_records.items() %}
                                    <div class="daily-attendance-card mb-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="mb-0 text-primary">
                                                        <i class="bi bi-calendar-day me-2"></i>{{ record.date|simple_date }}
                                                    </h6>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="attendance-time-entry">
                                                            {% if record.check_in %}
                                                            <div class="d-flex align-items-center">
                                                                <span class="badge bg-success me-3">
                                                                    <i class="bi bi-box-arrow-in-right"></i> Check In
                                                                </span>
                                                                <div>
                                                                    <div class="fw-bold">{{ record.check_in.verification_time|timeformat if record.check_in.verification_time else '--:--' }}</div>
                                                                    <small class="text-muted">{{ record.check_in.biometric_method|title }}</small>
                                                                </div>
                                                            </div>
                                                            {% else %}
                                                            <div class="d-flex align-items-center text-muted">
                                                                <span class="badge bg-secondary me-3">
                                                                    <i class="bi bi-dash"></i> No Check In
                                                                </span>
                                                                <small>Not recorded</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="attendance-time-entry">
                                                            {% if record.check_out %}
                                                            <div class="d-flex align-items-center">
                                                                <span class="badge bg-info me-3">
                                                                    <i class="bi bi-box-arrow-left"></i> Check Out
                                                                </span>
                                                                <div>
                                                                    <div class="fw-bold">{{ record.check_out.verification_time|timeformat if record.check_out.verification_time else '--:--' }}</div>
                                                                    <small class="text-muted">{{ record.check_out.biometric_method|title }}</small>
                                                                </div>
                                                            </div>
                                                            {% else %}
                                                            <div class="d-flex align-items-center text-muted">
                                                                <span class="badge bg-secondary me-3">
                                                                    <i class="bi bi-dash"></i> No Check Out
                                                                </span>
                                                                <small>Not recorded</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% if record.check_in and record.check_out %}
                                                <div class="mt-2 pt-2 border-top">
                                                    <small class="text-success">
                                                        <i class="bi bi-clock me-1"></i>
                                                        Work session completed
                                                    </small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-calendar-check"></i>
                                    </div>
                                    <h6 class="empty-title">No Attendance Records</h6>
                                    <p class="empty-text">Your daily attendance records will appear here once you start using biometric verification.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Leave Applications -->
                        <div class="salary-results-card mt-4">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-calendar-x"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">Leave Applications</h5>
                                    <p class="card-subtitle">Your leave request history and status</p>
                                </div>
                                <div class="header-actions">
                                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#applyLeaveModal">
                                        <i class="bi bi-plus"></i> Apply Leave
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if leave_applications %}
                                <div class="table-responsive">
                                    <table class="table salary-results-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>From</th>
                                                <th>To</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                                <th>Applied</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for leave in leave_applications %}
                                            <tr>
                                                <td><span class="badge bg-info">{{ leave.leave_type }}</span></td>
                                                <td>{{ leave.start_date|dateformat }}</td>
                                                <td>{{ leave.end_date|dateformat }}</td>
                                                <td>{{ leave.reason[:30] }}{% if leave.reason|length > 30 %}...{% endif %}</td>
                                                <td>
                                                    {% if leave.status == 'approved' %}
                                                        <span class="earnings-badge">Approved</span>
                                                    {% elif leave.status == 'rejected' %}
                                                        <span class="badge bg-danger">Rejected</span>
                                                    {% else %}
                                                        <span class="deductions-badge">Pending</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ leave.applied_at|dateformat }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-calendar-x"></i>
                                    </div>
                                    <h6 class="empty-title">No Leave Applications</h6>
                                    <p class="empty-text">You haven't applied for any leave yet. Click "Apply Leave" to submit your first request.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- On Duty Applications -->
                        <div class="salary-results-card mt-4">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-briefcase"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">On Duty Applications</h5>
                                    <p class="card-subtitle">Your on-duty request history and status</p>
                                </div>
                                <div class="header-actions">
                                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#applyOnDutyModal">
                                        <i class="bi bi-plus"></i> Apply On Duty
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if on_duty_applications %}
                                <div class="table-responsive">
                                    <table class="table salary-results-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>From</th>
                                                <th>To</th>
                                                <th>Location</th>
                                                <th>Purpose</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for duty in on_duty_applications %}
                                            <tr>
                                                <td><span class="badge bg-success">{{ duty.duty_type }}</span></td>
                                                <td>{{ duty.start_date|dateformat if duty.start_date else '-' }}</td>
                                                <td>{{ duty.end_date|dateformat if duty.end_date else '-' }}</td>
                                                <td>{{ duty.location or '-' }}</td>
                                                <td>{{ duty.purpose[:30] }}{% if duty.purpose|length > 30 %}...{% endif %}</td>
                                                <td>
                                                    {% if duty.status == 'approved' %}
                                                        <span class="earnings-badge">Approved</span>
                                                    {% elif duty.status == 'rejected' %}
                                                        <span class="badge bg-danger">Rejected</span>
                                                    {% else %}
                                                        <span class="deductions-badge">Pending</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-briefcase"></i>
                                    </div>
                                    <h6 class="empty-title">No On Duty Applications</h6>
                                    <p class="empty-text">You haven't applied for any on-duty yet. Click "Apply On Duty" to submit your first request.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Permission Applications -->
                        <div class="salary-results-card mt-4">
                            <div class="card-header">
                                <div class="header-icon">
                                    <i class="bi bi-clock-history"></i>
                                </div>
                                <div class="header-content">
                                    <h5 class="card-title">Permission Applications</h5>
                                    <p class="card-subtitle">Your permission request history and status</p>
                                </div>
                                <div class="header-actions">
                                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#applyPermissionModal">
                                        <i class="bi bi-plus"></i> Apply Permission
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if permission_applications %}
                                <div class="table-responsive">
                                    <table class="table salary-results-table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Duration</th>
                                                <th>Reason</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for permission in permission_applications %}
                                            <tr>
                                                <td><span class="badge bg-warning">{{ permission.permission_type }}</span></td>
                                                <td>{{ permission.permission_date|dateformat if permission.permission_date else '-' }}</td>
                                                <td>{{ permission.start_time|timeformat }} - {{ permission.end_time|timeformat }}</td>
                                                <td>{{ "%.1f"|format(permission.duration_hours) }} hrs</td>
                                                <td>{{ permission.reason[:30] }}{% if permission.reason|length > 30 %}...{% endif %}</td>
                                                <td>
                                                    {% if permission.status == 'approved' %}
                                                        <span class="earnings-badge">Approved</span>
                                                    {% elif permission.status == 'rejected' %}
                                                        <span class="badge bg-danger">Rejected</span>
                                                    {% else %}
                                                        <span class="deductions-badge">Pending</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-clock-history"></i>
                                    </div>
                                    <h6 class="empty-title">No Permission Applications</h6>
                                    <p class="empty-text">You haven't applied for any permission yet. Click "Apply Permission" to submit your first request.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-person text-primary"></i> Personal Information
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="profileFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="profileFirstName" name="first_name" value="{{ staff.first_name or '' }}">
                                </div>
                                <div class="rule-item">
                                    <label for="profileLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="profileLastName" name="last_name" value="{{ staff.last_name or '' }}">
                                </div>
                                <div class="rule-item">
                                    <label for="profileDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="profileDateOfBirth" name="date_of_birth" value="{{ staff.date_of_birth or '' }}">
                                </div>
                                <div class="rule-item">
                                    <label for="profileGender" class="form-label">Gender</label>
                                    <select class="form-select" id="profileGender" name="gender">
                                        <option value="">Select Gender</option>
                                        <option value="Male" {{ 'selected' if staff.gender == 'Male' else '' }}>Male</option>
                                        <option value="Female" {{ 'selected' if staff.gender == 'Female' else '' }}>Female</option>
                                        <option value="Other" {{ 'selected' if staff.gender == 'Other' else '' }}>Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-telephone text-warning"></i> Contact Information
                            </h6>
                            <div class="rules-grid">
                                <div class="rule-item">
                                    <label for="profileEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" name="email" value="{{ staff.email or '' }}">
                                </div>
                                <div class="rule-item">
                                    <label for="profilePhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="profilePhone" name="phone" value="{{ staff.phone or '' }}">
                                </div>
                            </div>
                        </div>

                        <div class="rules-section">
                            <h6 class="section-title">
                                <i class="bi bi-image text-info"></i> Profile Photo
                            </h6>
                            <div class="rule-item">
                                <label for="profilePhoto" class="form-label">Profile Photo</label>
                                <input type="file" class="form-control" id="profilePhoto" name="photo" accept="image/*">
                                <small class="form-text text-muted">Only PNG, JPG, JPEG, and GIF files are allowed.</small>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> Some fields like Staff ID, Department, Destination, Date of Joining, and Shift Type can only be updated by administrators.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="changePasswordBtn">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Leave Modal -->
    <div class="modal fade" id="applyLeaveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Apply for Leave</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="leaveForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="leaveType" class="form-label">Leave Type</label>
                            <select class="form-select" id="leaveType" name="leave_type" required>
                                <option value="" selected disabled>Select leave type</option>
                                <option value="CL">Casual Leave (CL)</option>
                                <option value="SL">Sick Leave (SL)</option>
                                <option value="EL">Earned Leave (EL)</option>
                                <option value="ML">Maternity Leave (ML)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="end_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="leaveReason" class="form-label">Reason</label>
                            <textarea class="form-control" id="leaveReason" name="reason" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLeave">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply On Duty Modal -->
    <div class="modal fade" id="applyOnDutyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Apply for On Duty</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="onDutyForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyType" class="form-label">Duty Type</label>
                                    <select class="form-select" id="dutyType" name="duty_type" required>
                                        <option value="" selected disabled>Select duty type</option>
                                        <option value="Official Work">Official Work</option>
                                        <option value="Training">Training</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Conference">Conference</option>
                                        <option value="Field Work">Field Work</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyLocation" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="dutyLocation" name="location" placeholder="Enter location">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="dutyStartDate" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyEndDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="dutyEndDate" name="end_date" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyStartTime" class="form-label">Start Time (Optional)</label>
                                    <input type="time" class="form-control" id="dutyStartTime" name="start_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dutyEndTime" class="form-label">End Time (Optional)</label>
                                    <input type="time" class="form-control" id="dutyEndTime" name="end_time">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="dutyPurpose" class="form-label">Purpose</label>
                            <textarea class="form-control" id="dutyPurpose" name="purpose" rows="2" required placeholder="Brief description of the duty purpose"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="dutyReason" class="form-label">Additional Details (Optional)</label>
                            <textarea class="form-control" id="dutyReason" name="reason" rows="2" placeholder="Any additional information"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="submitOnDuty">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Permission Modal -->
    <div class="modal fade" id="applyPermissionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Apply for Permission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="permissionForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="permissionType" class="form-label">Permission Type</label>
                            <select class="form-select" id="permissionType" name="permission_type" required>
                                <option value="" selected disabled>Select permission type</option>
                                <option value="Personal Work">Personal Work</option>
                                <option value="Medical">Medical</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Family Function">Family Function</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="permissionDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="permissionDate" name="permission_date" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="permissionStartTime" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="permissionStartTime" name="start_time" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="permissionEndTime" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="permissionEndTime" name="end_time" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="permissionReason" class="form-label">Reason</label>
                            <textarea class="form-control" id="permissionReason" name="reason" rows="3" required placeholder="Please provide detailed reason for permission"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="submitPermission">Submit Application</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Current date display
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            document.getElementById('currentDate').textContent = dateStr;
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Helper function to get CSRF token
        function getCSRFToken() {
            const token = document.querySelector('input[name="csrf_token"]');
            return token ? token.value : '';
        }

        // Apply on duty functionality
        const submitOnDuty = document.getElementById('submitOnDuty');
        submitOnDuty?.addEventListener('click', function () {
            const form = document.getElementById('onDutyForm');
            const formData = new FormData(form);

            // Basic validation
            const dutyType = formData.get('duty_type');
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            const purpose = formData.get('purpose');

            if (!dutyType || !startDate || !endDate || !purpose) {
                alert('Please fill all required fields');
                return;
            }

            // Check if end date is after start date
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after or equal to start date');
                return;
            }

            fetch('/apply_on_duty', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'On-duty application submitted successfully');
                        bootstrap.Modal.getInstance(document.getElementById('applyOnDutyModal')).hide();
                        form.reset();
                        location.reload();
                    } else {
                        alert(data.error || 'Failed to submit on-duty application');
                    }
                })
                .catch(error => {
                    console.error('Error submitting on-duty application:', error);
                    alert('Error submitting on-duty application');
                });
        });

        // Apply permission functionality
        const submitPermission = document.getElementById('submitPermission');
        submitPermission?.addEventListener('click', function () {
            const form = document.getElementById('permissionForm');
            const formData = new FormData(form);

            // Basic validation
            const permissionType = formData.get('permission_type');
            const permissionDate = formData.get('permission_date');
            const startTime = formData.get('start_time');
            const endTime = formData.get('end_time');
            const reason = formData.get('reason');

            if (!permissionType || !permissionDate || !startTime || !endTime || !reason) {
                alert('Please fill all required fields');
                return;
            }

            // Check if end time is after start time
            if (startTime >= endTime) {
                alert('End time must be after start time');
                return;
            }

            fetch('/apply_permission', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'Permission application submitted successfully');
                        bootstrap.Modal.getInstance(document.getElementById('applyPermissionModal')).hide();
                        form.reset();
                        location.reload();
                    } else {
                        alert(data.error || 'Failed to submit permission application');
                    }
                })
                .catch(error => {
                    console.error('Error submitting permission application:', error);
                    alert('Error submitting permission application');
                });
        });

        // Enhanced attendance stat card styles
        const style = document.createElement('style');
        style.textContent = `
            .attendance-stat-card {
                border: 1px solid rgba(0, 0, 0, 0.08);
                border-radius: 1rem;
                padding: 1.5rem;
                display: flex;
                align-items: center;
                gap: 1rem;
                transition: all 0.3s ease;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }
            .attendance-stat-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            .attendance-stat-card .stat-icon {
                font-size: 2rem;
                flex-shrink: 0;
            }
            .attendance-stat-card .stat-content {
                flex: 1;
            }
            .attendance-stat-card .stat-value {
                font-size: 2rem;
                font-weight: 700;
                line-height: 1;
                margin-bottom: 0.25rem;
            }
            .attendance-stat-card .stat-label {
                color: #6c757d;
                font-size: 0.9rem;
                font-weight: 500;
            }
            .profile-avatar-img, .profile-avatar-placeholder {
                box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
                transition: all 0.3s ease;
            }
            .profile-avatar-img:hover, .profile-avatar-placeholder:hover {
                transform: scale(1.05);
                box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
            }
            .daily-attendance-card {
                transition: all 0.3s ease;
            }
            .daily-attendance-card:hover {
                transform: translateY(-2px);
            }
            .daily-attendance-card .card {
                border-radius: 0.75rem;
                overflow: hidden;
            }
            .attendance-time-entry {
                padding: 0.75rem;
                border-radius: 0.5rem;
                background: rgba(248, 249, 250, 0.8);
                transition: all 0.3s ease;
            }
            .attendance-time-entry:hover {
                background: rgba(233, 236, 239, 0.8);
                transform: translateY(-1px);
            }
            .daily-attendance-list {
                max-height: 600px;
                overflow-y: auto;
                padding-right: 0.5rem;
            }
            .daily-attendance-list::-webkit-scrollbar {
                width: 6px;
            }
            .daily-attendance-list::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            .daily-attendance-list::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }
            .daily-attendance-list::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="{{ url_for('static', filename='js/weekly_calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/staff_profile_page.js') }}"></script>
</body>
</html>
